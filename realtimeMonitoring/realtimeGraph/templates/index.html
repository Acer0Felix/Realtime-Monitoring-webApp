{% extends 'base.html' %} {% load static %} {% block head %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/data.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="{% static 'lib/highcharts-8.1.2/modules/export-data.js' %}"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
{% endblock %} {% block content %}
<br />
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-12">
      {% for measure in measurements %}
      <div id="container-realtime-{{measure.name}}"></div>
      {% if data %}
      <div class="row">
        <div class="col-4">
          <div class="form-group">
            <label for="avg">Promedio:</label>
            {% with name=measure.name %}  
            {% with key=name|add_str:',avg' %}  
            <p>{{data|get_statistic:key}}</p>
            {% endwith %} 
            {% endwith %}
          </div>
        </div>
        <div class="col-4">
          <div class="form-group">
            <label for="min">Mínimo:</label>
            {% with name=measure.name %}  
            {% with key=name|add_str:',min' %}  
            <p>{{data|get_statistic:key}}</p>
            {% endwith %} 
            {% endwith %}
          </div>
        </div>
        <div class="col-4">
          <div class="form-group">
            <label for="max">Máximo:</label>
            {% with name=measure.name %}  
            {% with key=name|add_str:',max' %}  
            <p>{{data|get_statistic:key}}</p>
            {% endwith %} 
            {% endwith %}
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
      <br />
      <div class="form-row">
        {% if selectedUser %}
        <div class="col">
          <div class="form-group">
            <label for="ciudad">Ciudad:</label>
            <select
              class="form-control"
              aria-label="Seleccionar ciudad"
              aria-placeholder="Ciudad"
              onchange="this.options[this.selectedIndex].value && (window.location = '/historical/' + this.options[this.selectedIndex].value);"
            >
              <option value="">Todas</option>
              {% for city in cities %}
              <option value="{{city.name}}"
              {% if selectedCity.name == city.name %}
                selected
                {% endif %}>{{city.name}}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<div>
  {{data|json_script:'data'}}
</div>
<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
<script type="application/javascript">
        var data = JSON.parse(document.getElementById('data').textContent);
        var charts = {};
        Object.keys(data).forEach(function(key) {
         charts[key] = Highcharts.chart("container-realtime-"+key, {
        chart: {
          zoomType: "x",
        },
        title: {
          text: key,
        },
        subtitle: {
          text:
            document.ontouchstart === undefined
              ? "Click and drag in the plot area to zoom in"  
              : "Pinch the chart to zoom in",
        },
        xAxis: {
          type: "datetime",
        },
        yAxis: {
          title: {
            text: "Value",
          },
        },
        legend: {
          enabled: false,
        },
        plotOptions: {
          area: {
            fillColor: {
              linearGradient: {
                x1: 0,
                y1: 0,
                x2: 0,
                y2: 1,
              },
              stops: [
                [0, Highcharts.getOptions().colors[0]],
                [
                  1,
                  Highcharts.color(Highcharts.getOptions().colors[0])
                    .setOpacity(0)
                    .get("rgba"),
                ],
              ],
            },
            marker: {
              radius: 2,
            },
            lineWidth: 1,
            states: {
              hover: {
                lineWidth: 1,
              },
            },
            threshold: null,
          },
        },

        series: [
          {
            type: "line",
            name: "Value",
            data: data[key].data,
          },
        ],
      });
        });

    setInterval(async () => {
      var data = {
        city: "{{selectedCity.name}}",
        action: "get_data"
      }
      var url = '/';
      let res = await fetch(url, {
        method: "POST", 
        body: JSON.stringify(data),
        });
      var data = await res.json();
      if (data.result) {
        for (const key in data.result) {
          if (Object.hasOwnProperty.call(data.result, key)) {
            const element = data.result[key];
;            charts[key].update({
              series: [
          {
            type: "line",
            name: "Value",
            data: element.data,
          },
        ],
            });
          }
        }
      }
    }, 3000);
</script>

{% endblock %}
